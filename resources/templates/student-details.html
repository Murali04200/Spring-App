<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Student Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">Students App</a>
        <div class="ms-auto d-flex gap-2">
            <a class="btn btn-outline-light" th:href="@{/students}">Back</a>
            <a class="btn btn-warning" th:href="@{/teacher/marks}">Enter Marks</a>
        </div>
    </div>
</nav>
<div class="container mt-4">
    <div class="row g-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0" th:text="${student.name}">Student Name</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#enterMarkModal" sec:authorize="hasAuthority('PERM_I')">
                            Enter/Update Mark
                        </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-4"><strong>Email:</strong> <span th:text="${student.email}">-</span></div>
                        <div class="col-md-4"><strong>Class:</strong> <span th:text="${student.className} ?: '-'">-</span></div>
                        <div class="col-md-4"><strong>Total Marks:</strong> <span class="badge bg-primary" th:text="${student.totalMarks} ?: 'NIL'">NIL</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">Subject-wise Marks</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Subject</th>
                            <th>Code</th>
                            <th>Teacher</th>
                            <th class="text-end">Mark</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.isEmpty(marks)}">
                            <td colspan="5" class="text-center text-muted p-3">No marks entered yet.</td>
                        </tr>
                        <tr th:each="m, i : ${marks}">
                            <td th:text="${i.index + 1}">1</td>
                            <td th:text="${m.subject.name}">Mathematics</td>
                            <td th:text="${m.subject.code}">MATH</td>
                            <td th:text="${m.teacher.name}">Teacher Name</td>
                            <td class="text-end" th:text="${m.mark}">90</td>
                        </tr>
                        </tbody>
                        <tfoot th:if="${!#lists.isEmpty(marks)}">
                        <tr>
                            <th colspan="4" class="text-end">Total</th>
                            <th class="text-end" th:text="${student.totalMarks} ?: 'NIL'">NIL</th>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enter Mark Modal -->
<div class="modal fade" id="enterMarkModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enter/Update Mark</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/teacher/marks}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" name="studentId" th:value="${student.id}" />
        <!-- Redirect back to this details page after saving mark -->
        <input type="hidden" name="redirectTo" th:value="@{'/students/' + ${student.id} + '/details'}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Subject</label>
            <select class="form-select" id="sd-subjectSelect" name="subjectCode" required>
              <option value="" disabled selected>Choose subject</option>
              <option th:each="sub : ${subjects}" th:value="${sub.code}" th:text="${sub.name} + ' (' + ${sub.code} + ')'">Subj</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Teacher</label>
            <select class="form-select" id="sd-teacherSelect" name="teacherEmail" required>
              <option value="" disabled selected>Choose teacher</option>
              <option th:each="t : ${teachers}" th:value="${t.email}" th:text="${t.name} + ' (' + ${t.subjectCode} + ')'">Teach</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Mark (0-100)</label>
            <input type="number" class="form-control" name="mark" min="0" max="100" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" sec:authorize="hasAuthority('PERM_I')">Save</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function(){
      const modal = document.getElementById('enterMarkModal');
      if (!modal) return;
      const subjSelect = modal.querySelector('#sd-subjectSelect');
      const teacherSelect = modal.querySelector('#sd-teacherSelect');
      function clearTeachers(){ while (teacherSelect && teacherSelect.options.length > 1) teacherSelect.remove(1); }
      function loadTeachersForSubject(code){
        if (!teacherSelect || !code) return;
        fetch('/api/teachers?subjectCode=' + encodeURIComponent(code))
          .then(r => r.json())
          .then(arr => {
            clearTeachers();
            arr.forEach(t => {
              const opt = document.createElement('option');
              opt.value = t.email; opt.textContent = `${t.name} (${t.subjectCode})`;
              teacherSelect.appendChild(opt);
            });
          })
          .catch(()=>{});
      }
      if (subjSelect) {
        subjSelect.addEventListener('change', function(){ loadTeachersForSubject(this.value); });
      }
    })();
  </script>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
