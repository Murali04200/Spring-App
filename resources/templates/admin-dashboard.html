<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
          background: linear-gradient(135deg, #eef2ff, #e0f2fe);
          min-height: 100vh;
          display: flex;
        }

        /* Sidebar */
        .sidebar {
          height: 100vh;
          width: 240px;
          background-color: #1f2937;
          position: fixed;
          top: 0;
          left: 0;
          padding-top: 60px;
        }
        .sidebar a {
          color: #9ca3af;
          padding: 15px 20px;
          display: flex;
          align-items: center;
          gap: 10px;
          text-decoration: none;
          transition: 0.3s;
        }
        .sidebar a:hover {
          background-color: #374151;
          color: #fff;
        }

        .sidebar-section {
          margin-top: 18px;
        }

        .sidebar-label {
          font-size: 0.75rem;
          letter-spacing: .08em;
          text-transform: uppercase;
          color: #6b7280;
          padding: 0 20px 6px;
          display: block;
        }

        /* Content */
        .content {
          margin-left: 240px;
          padding: 20px;
          width: 100%;
        }

        /* Header */
        .navbar {
          background: linear-gradient(90deg, #2563eb, #4f46e5);
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          border-radius: 10px;
        }

        /* Cards with Double Gradient */
        .dashboard-card {
          min-height: 200px;
          border-radius: 18px;
          color: black;
          text-align: center;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-decoration: none;
          position: relative;
          overflow: hidden;
          padding: 18px;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          background: rgba(255,255,255,0.65);
          border: 1px solid rgba(255,255,255,0.35);
          backdrop-filter: blur(6px);
        }

        /* Gradient Border Effect */
        .dashboard-card::before {
          content: "";
          position: absolute;
          inset: -3px;
          border-radius: 20px;
          background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
          z-index: -1;
          filter: blur(8px);
          opacity: 0.55;
          transition: opacity 0.3s ease, filter 0.3s ease;
        }

        /* Glossy shine overlay */
        .dashboard-card::after {
          content: "";
          position: absolute;
          top: -40%;
          left: -20%;
          width: 140%;
          height: 60%;
          background: radial-gradient(ellipse at top, rgba(255,255,255,.65), rgba(255,255,255,0) 60%);
          transform: rotate(-8deg);
          pointer-events: none;
        }

        .stat-card {
          border-radius: 16px;
          padding: 18px;
          background: rgba(255,255,255,0.8);
          border: 1px solid rgba(255,255,255,0.4);
          backdrop-filter: blur(6px);
          box-shadow: 0 14px 30px rgba(15,23,42,.12);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .stat-card h2 {
          font-size: 2.2rem;
          margin: 0;
        }

        .stat-icon {
          width: 52px;
          height: 52px;
          border-radius: 14px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 12px 26px rgba(37,99,235,.2);
          background: linear-gradient(135deg,#2563eb,#7c3aed);
          color: #fff;
        }

        .chart-card {
          border-radius: 18px;
          padding: 20px;
          background: rgba(255,255,255,0.78);
          border: 1px solid rgba(255,255,255,0.45);
          box-shadow: 0 16px 36px rgba(15,23,42,.14);
          backdrop-filter: blur(6px);
        }

        .recent-table thead {
          background: linear-gradient(135deg,#2563eb,#4f46e5);
          color: #fff;
        }

        .dashboard-card:hover {
          transform: translateY(-6px) scale(1.03);
          box-shadow: 0 0 18px rgba(0,0,0,0.25);
        }
        .dashboard-card:hover::before {
          opacity: 1;
          filter: blur(2px);
        }

        /* Logout button */
        .btn-gradient {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            color: white;
            border: none;
            transition: 0.3s;
        }
        .btn-gradient:hover {
            background: linear-gradient(90deg, #ec4899, #db2777);
            color: white;
        }

        /* Smooth Inner Gradients */
        .gradient-blue {
          background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }
        .gradient-soft-pink {
          background: linear-gradient(135deg, #ec4899, #f472b6);
        }
        .gradient-soft-indigo {
          background: linear-gradient(135deg, #6366f1, #a78bfa);
        }

        /* Icons */
        .dashboard-icon {
          font-size: 2.6rem;
          margin-bottom: 8px;
        }

        /* Icon badge containers */
        .icon-badge {
          width: 64px;
          height: 64px;
          border-radius: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #fff;
          margin-bottom: 10px;
          box-shadow: 0 10px 24px rgba(0,0,0,.18);
        }
        .badge-blue { background: linear-gradient(135deg, #2563eb, #60a5fa); }
        .badge-pink { background: linear-gradient(135deg, #ec4899, #f472b6); }
        .badge-indigo { background: linear-gradient(135deg, #4f46e5, #a78bfa); }

        /* Sidebar logout button styled as link */
        .sidebar form.sidebar-logout { margin: 0; }
        .sidebar .logout-btn {
          background: transparent;
          border: none;
          width: 100%;
          text-align: left;
          color: #9ca3af;
          padding: 15px 20px;
          display: flex;
          align-items: center;
          gap: 10px;
          cursor: pointer;
          transition: .3s;
        }
        .sidebar .logout-btn:hover { background-color: #374151; color: #fff; }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <a href="/admin/dashboard">
        <i class="bi bi-house-fill fs-5"></i>
        <span>Dashboard</span>
    </a>

    <div class="sidebar-section" sec:authorize="hasAuthority('PERM_A') or hasAuthority('PERM_D') or hasAuthority('PERM_E') or hasAuthority('PERM_F')">
        <span class="sidebar-label">Keycloak</span>
        <a href="/admin/keycloak-users" sec:authorize="hasAnyAuthority('PERM_A','PERM_D')"><i class="bi bi-people-fill"></i> Keycloak Users</a>
        <a href="/admin/keycloak-users/new" sec:authorize="hasAuthority('PERM_A')">
            <i class="bi bi-shield-lock-fill"></i> Create User
        </a>
        <a href="/admin/permissions" sec:authorize="hasAuthority('PERM_E')">
            <i class="bi bi-shield-check"></i> Permissions
        </a>
        <a href="/admin/permissions/new" sec:authorize="hasAuthority('PERM_F')">
            <i class="bi bi-plus-circle"></i> Create Permission
        </a>
    </div>

    <div class="sidebar-section" sec:authorize="hasAuthority('PERM_A') or hasAuthority('PERM_B') or hasAuthority('PERM_C') or hasAuthority('PERM_E')">
        <span class="sidebar-label">Students</span>
        <a href="/admin/students" sec:authorize="hasAnyAuthority('PERM_A','PERM_B','PERM_C','PERM_E')"><i class="bi bi-people-fill"></i> Student List</a>
        <a href="/students/new" sec:authorize="hasAuthority('PERM_A')"><i class="bi bi-person-plus-fill"></i> Add Student</a>
    </div>

    <div class="sidebar-section" sec:authorize="hasAuthority('PERM_J') or hasAuthority('PERM_H') or hasAuthority('PERM_I')">
        <span class="sidebar-label">Teachers &amp; Marks</span>
        <a href="#" sec:authorize="hasAuthority('PERM_J')" data-bs-toggle="modal" data-bs-target="#teacherRosterModal">
            <i class="bi bi-people-fill"></i> Teacher Roster
        </a>
        <a href="/teacher/new" sec:authorize="hasAuthority('PERM_H')">
            <i class="bi bi-mortarboard-fill"></i> Create Teacher
        </a>
        <a href="/teacher/marks" sec:authorize="hasAuthority('PERM_I')">
            <i class="bi bi-journal-check"></i> Enter Marks
        </a>
    </div>

    <form th:action="@{/logout}" method="post" class="sidebar-logout">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="logout-btn">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
        </button>
    </form>
</div>

<!-- Page Content -->
<div class="content">
    <!-- Header -->
   <!-- <h1 class="mb-4">
        <span sec:authorize="hasAuthority('ROLE_admin')">Welcome Admin</span>
        <span sec:authorize="hasAuthority('ROLE_manager')">Welcome Manager</span>
        <span sec:authorize="hasAuthority('ROLE_jrmanager')">Welcome JrManager</span>
        - <span sec:authentication="name"></span>
    </h1>
-->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                ✨
                <span>Dashboard</span>
                <!--<span sec:authorize="hasRole('clerk')">Clerk Dashboard</span>
                <span sec:authorize="hasRole('user')">User Dashboard</span> -->
                &nbsp;|&nbsp;
                <span sec:authentication="name"></span>
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto align-items-center gap-2">
                    <!-- Profile modal trigger -->
                    <li class="nav-item">
                        <button type="button" class="btn d-flex align-items-center justify-content-center"
                                data-bs-toggle="modal" data-bs-target="#profileModal"
                                style="width:42px;height:42px;border-radius:50%;
                                       background: linear-gradient(135deg,#7c3aed,#2563eb);
                                       color:#fff; box-shadow:0 6px 14px rgba(0,0,0,.25)">
                            <i class="bi bi-person-fill fs-5"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>



    <!-- Analytics Section -->
    <div class="container pt-3 pt-lg-4">
        <div class="row mb-3">
            <div class="col-12" th:if="${teacherUpdated}" sec:authorize="hasAuthority('PERM_H')">
                <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    Teacher updated successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
            <div class="col-12" th:if="${teacherDeleted}" sec:authorize="hasAuthority('PERM_H')">
                <div class="alert alert-warning alert-dismissible fade show shadow-sm" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Teacher deleted.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
            <div class="col-12" th:if="${teacherError}" sec:authorize="hasAuthority('PERM_H')">
                <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
                    <i class="bi bi-x-circle me-2"></i>
                    <span th:text="${teacherError}">Unable to update teacher.</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-12" th:if="${hasTeacherProfile == false}">
                <div class="alert alert-warning shadow-sm d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="alert-heading mb-1">Complete your teacher profile</h5>
                        <p class="mb-0">We couldn’t find a teacher record linked to your account. Create or update your teacher profile to start recording marks.</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a class="btn btn-primary" th:href="@{/teacher/details/me}"><i class="bi bi-person-badge"></i> View Profile</a>
                        <a class="btn btn-outline-secondary" th:href="@{/teacher/new}" sec:authorize="hasAuthority('PERM_H')"><i class="bi bi-mortarboard-fill"></i> Create Teacher</a>
                    </div>
                </div>
            </div>
            <div class="col-12" th:if="${marksCount == 0}">
                <div class="alert alert-info shadow-sm d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="alert-heading mb-1">No marks recorded yet</h5>
                        <p class="mb-0">Kickstart mark tracking by entering subject marks. This helps keep student records up to date.</p>
                    </div>
                    <a class="btn btn-primary" th:href="@{/teacher/marks}"><i class="bi bi-journal-plus"></i> Enter Marks</a>
                </div>
            </div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div>
                        <div class="text-muted text-uppercase small">Total Students</div>
                        <h2 th:text="${studentCount}">0</h2>
                    </div>
                    <div class="stat-icon"><i class="bi bi-people-fill fs-4"></i></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div>
                        <div class="text-muted text-uppercase small">Total Faculty</div>
                        <h2 th:text="${teacherCount}">0</h2>
                    </div>
                    <div class="stat-icon"><i class="bi bi-mortarboard fs-4"></i></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div>
                        <div class="text-muted text-uppercase small">Marks Recorded</div>
                        <h2 th:text="${marksCount}">0</h2>
                    </div>
                    <div class="stat-icon"><i class="bi bi-journal-check fs-4"></i></div>
                </div>
            </div>
        </div>

        <!-- Cards Section -->
        <div class="mb-4"></div>

        <h4 class="text-muted text-uppercase fw-semibold mb-3"
            sec:authorize="hasAuthority('PERM_A') or hasAuthority('PERM_D') or hasAuthority('PERM_G')">
            Keycloak Management
        </h4>
        <div class="row g-4 mb-5"
             sec:authorize="hasAuthority('PERM_A') or hasAuthority('PERM_D') or hasAuthority('PERM_G')">
            <div class="col-md-4" sec:authorize="hasAuthority('PERM_A')">
                <a href="/admin/keycloak-users/new" class="card dashboard-card gradient-soft-pink">
                    <div class="icon-badge badge-pink">
                        <i class="bi bi-shield-lock-fill dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold">Create User</h5>
                    <p>Add a Keycloak user</p>
                </a>
            </div>
            <div class="col-md-4" sec:authorize="hasAnyAuthority('PERM_A','PERM_D','PERM_G')">
                <a href="/admin/keycloak-users" class="card dashboard-card gradient-blue">
                    <div class="icon-badge badge-blue">
                        <i class="bi bi-people-fill dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold">Keycloak Users</h5>
                    <p>Manage users and roles</p>
                </a>
            </div>
            <div class="col-md-4" sec:authorize="hasAuthority('PERM_G')">
                <a href="/admin/permissions" class="card dashboard-card gradient-soft-indigo">
                    <div class="icon-badge badge-indigo">
                        <i class="bi bi-shield-check dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold">Permissions</h5>
                    <p>View and assign permissions</p>
                </a>
            </div>
            <div class="col-md-4" sec:authorize="hasAuthority('PERM_G')">
                <a href="/admin/permissions/new" class="card dashboard-card gradient-soft-pink">
                    <div class="icon-badge badge-pink">
                        <i class="bi bi-plus-circle dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold">Create Permission</h5>
                    <p>Add a new permission (A–Z)</p>
                </a>
            </div>
        </div>

        <h4 class="text-muted text-uppercase fw-semibold mb-3"
            sec:authorize="hasAuthority('PERM_A') or hasAuthority('PERM_B') or hasAuthority('PERM_C') or hasAuthority('PERM_E')">
            Student Management
        </h4>
        <div class="row g-4 mb-5"
             sec:authorize="hasAuthority('PERM_A') or hasAuthority('PERM_B') or hasAuthority('PERM_C') or hasAuthority('PERM_E')">
            <div class="col-md-4" sec:authorize="hasAuthority('PERM_A')">
                <a href="/students/new" class="card dashboard-card gradient-blue">
                    <div class="icon-badge badge-blue">
                        <i class="bi bi-person-plus-fill dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold">Add Student</h5>
                    <p>Register a new student</p>
                </a>
            </div>
            <div class="col-md-4" sec:authorize="hasAnyAuthority('PERM_A','PERM_B','PERM_C','PERM_E')">
                <a href="/admin/students" class="card dashboard-card gradient-soft-indigo">
                    <div class="icon-badge badge-indigo">
                        <i class="bi bi-journal-text dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold">Students</h5>
                    <p>Browse student records</p>
                </a>
            </div>
        </div>

        <h4 class="text-muted text-uppercase fw-semibold mb-3"
            sec:authorize="hasAuthority('PERM_J') or hasAuthority('PERM_H') or hasAuthority('PERM_I')">
            Teacher &amp; Marks
        </h4>
        <div class="row g-4 justify-content-start"
             sec:authorize="hasAuthority('PERM_J') or hasAuthority('PERM_H') or hasAuthority('PERM_I')">
            <div class="col-md-4" sec:authorize="hasAuthority('PERM_J')">
                <a href="#" class="card dashboard-card gradient-soft-indigo text-decoration-none" data-bs-toggle="modal" data-bs-target="#teacherRosterModal">
                    <div class="icon-badge badge-indigo">
                        <i class="bi bi-people-fill dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold mb-1">Teacher Roster</h5>
                    <p class="mb-0">View and manage teacher assignments</p>
                </a>
            </div>
            <div class="col-md-4" sec:authorize="hasAuthority('PERM_H')">
                <a href="/teacher/new" class="card dashboard-card gradient-blue">
                    <div class="icon-badge badge-blue">
                        <i class="bi bi-mortarboard-fill dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold">Create Teacher</h5>
                    <p>Add and manage teacher details</p>
                </a>
            </div>
            <div class="col-md-4" sec:authorize="hasAuthority('PERM_I')">
                <a href="/teacher/marks" class="card dashboard-card gradient-soft-indigo">
                    <div class="icon-badge badge-indigo">
                        <i class="bi bi-journal-check dashboard-icon text-white"></i>
                    </div>
                    <h5 class="fw-bold">Enter Marks</h5>
                    <p>Record subject-wise marks for students</p>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Teacher Modals -->
<div class="modal fade" id="teacherRosterModal" tabindex="-1" aria-hidden="true" sec:authorize="hasAuthority('PERM_J')">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0" style="border-radius: 16px; overflow:hidden;">
            <div class="modal-header text-white" style="background: linear-gradient(135deg,#2563eb,#4f46e5);">
                <div>
                    <h5 class="modal-title fw-bold mb-0"><i class="bi bi-people-fill me-2"></i>Teacher Roster</h5>
                    <small class="text-white-50">Review and manage teacher assignments</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Teacher ID</th>
                                <th>Subject</th>
                                <th>Email</th>
                                <th>Classes</th>
                                <th class="text-center" sec:authorize="hasAuthority('PERM_H')">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${#lists.isEmpty(teachers)}">
                                <td colspan="6" class="text-center text-muted py-4">No teachers found.</td>
                            </tr>
                            <tr th:each="teacher : ${teachers}">
                                <td class="fw-semibold" th:text="${teacher.name}">Jane Doe</td>
                                <td th:text="${teacher.id}">12</td>
                                <td th:text="${teacher.subjectCode}">MATH</td>
                                <td th:text="${teacher.email}">jane@example.com</td>
                                <td th:text="${teacher.department}">5,6,7</td>
                                <td class="text-center" sec:authorize="hasAuthority('PERM_H')">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" data-bs-toggle="modal"
                                                th:data-bs-target="'#editTeacherModal-' + ${teacher.id}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" data-bs-toggle="modal"
                                                th:data-bs-target="'#deleteTeacherModal-' + ${teacher.id}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0">
                <a href="/teacher/new" class="btn btn-primary" sec:authorize="hasAuthority('PERM_H')"><i class="bi bi-person-plus"></i> Add Teacher</a>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div th:each="teacher : ${teachers}">
    <div th:id="'editTeacherModal-' + ${teacher.id}" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <form th:action="@{'/teacher/' + ${teacher.id} + '/update'}" method="post" class="needs-validation">
                    <div class="modal-header text-white"
                         style="background: linear-gradient(135deg, #2563eb, #4f46e5); border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                        <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i> Edit Teacher</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" name="name" class="form-control shadow-sm rounded-pill" th:value="${teacher.name}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject Code</label>
                            <input type="text" name="subjectCode" class="form-control shadow-sm rounded-pill" th:value="${teacher.subjectCode}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control shadow-sm rounded-pill" th:value="${teacher.email}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Classes (comma separated)</label>
                            <input type="text" name="department" class="form-control shadow-sm rounded-pill" th:value="${teacher.department}" placeholder="5,6,7">
                            <div class="form-text">Used to sync teacher assignments per class.</div>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="submit" class="btn btn-success rounded-pill px-4 shadow-sm">
                            <i class="bi bi-check-circle"></i> Save
                        </button>
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div th:id="'deleteTeacherModal-' + ${teacher.id}" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <form th:action="@{'/teacher/' + ${teacher.id} + '/delete'}" method="post">
                    <div class="modal-header text-white"
                         style="background: linear-gradient(135deg, #d32f2f, #ef5350); border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                        <h5 class="modal-title fw-bold"><i class="bi bi-trash-fill me-2"></i> Confirm Delete</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
                        <p class="fw-bold fs-5">Are you sure you want to delete <strong th:text="${teacher.name}">Teacher</strong>?</p>
                        <p class="text-muted mb-0">This will remove teacher assignments and profile.</p>
                    </div>
                    <div class="modal-footer justify-content-center border-0">
                        <button type="submit" class="btn btn-danger rounded-pill px-4 shadow-sm">
                            <i class="bi bi-check-circle"></i> Yes, Delete
                        </button>
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Teacher Modals -->
<div th:each="teacher : ${teachers}">
    <div th:id="'editTeacherModal-' + ${teacher.id}" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <form th:action="@{'/teacher/' + ${teacher.id} + '/update'}" method="post" class="needs-validation">
                    <div class="modal-header text-white"
                         style="background: linear-gradient(135deg, #2563eb, #4f46e5); border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                        <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i> Edit Teacher</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" name="name" class="form-control shadow-sm rounded-pill" th:value="${teacher.name}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject Code</label>
                            <input type="text" name="subjectCode" class="form-control shadow-sm rounded-pill" th:value="${teacher.subjectCode}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control shadow-sm rounded-pill" th:value="${teacher.email}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Classes (comma separated)</label>
                            <input type="text" name="department" class="form-control shadow-sm rounded-pill" th:value="${teacher.department}" placeholder="5,6,7">
                            <div class="form-text">Used to sync teacher assignments per class.</div>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="submit" class="btn btn-success rounded-pill px-4 shadow-sm">
                            <i class="bi bi-check-circle"></i> Save
                        </button>
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div th:id="'deleteTeacherModal-' + ${teacher.id}" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <form th:action="@{'/teacher/' + ${teacher.id} + '/delete'}" method="post">
                    <div class="modal-header text-white"
                         style="background: linear-gradient(135deg, #d32f2f, #ef5350); border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                        <h5 class="modal-title fw-bold"><i class="bi bi-trash-fill me-2"></i> Confirm Delete</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
                        <p class="fw-bold fs-5">Are you sure you want to delete <strong th:text="${teacher.name}">Teacher</strong>?</p>
                        <p class="text-muted mb-0">This will remove teacher assignments and profile.</p>
                    </div>
                    <div class="modal-footer justify-content-center border-0">
                        <button type="submit" class="btn btn-danger rounded-pill px-4 shadow-sm">
                            <i class="bi bi-check-circle"></i> Yes, Delete
                        </button>
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-JfcCXsMkRUYw35vj0IadB1iKsFcfoTmyaKOA1NVuMcZpNigC4D4ew3Efr2E1VlzD" crossorigin="anonymous"></script>
<script th:inline="javascript">
  const classLabels = [];
  const classCounts = [];
  /*[# th:each="entry : ${classDistribution}"]*/
  classLabels.push(/*[[${entry.className() == null ? 'Unknown' : entry.className()}]]*/'Unknown');
  classCounts.push(/*[[${entry.count()}]]*/0);
  /*[/]*/

  const subjectLabels = [];
  const subjectCounts = [];
  /*[# th:each="entry : ${marksBySubject}"]*/
  subjectLabels.push(/*[[${entry.code()}]]*/'SUB');
  subjectCounts.push(/*[[${entry.count()}]]*/0);
  /*[/]*/

  const palette = ['#2563eb','#7c3aed','#ec4899','#f97316','#14b8a6','#facc15','#22c55e','#8b5cf6','#f472b6','#0ea5e9'];

  function buildBarChart(ctxId, labels, data) {
    const canvas = document.getElementById(ctxId);
    if (!canvas || typeof Chart === 'undefined') return;
    new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '',
          data,
          backgroundColor: labels.map((_, idx) => palette[idx % palette.length])
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        }
      }
    });
  }

  buildBarChart('classDistributionChart', classLabels, classCounts);
  buildBarChart('marksBySubjectChart', subjectLabels, subjectCounts);
</script>
<script>
    // Prevent back navigation
    (function() {
        window.history.pushState(null, "", window.location.href);
        window.onpopstate = function () {
            window.history.pushState(null, "", window.location.href);
        };
    })();
</script>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-sm modal-dialog-scrollable">
    <div class="modal-content border-0" style="border-radius:16px; overflow:hidden;">
      <div class="p-4 text-white" style="background: linear-gradient(135deg,#2563eb,#7c3aed);">
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center justify-content-center"
               style="width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.2);">
            <i class="bi bi-person-fill fs-3"></i>
          </div>
          <div>
            <div class="fw-bold" sec:authentication="name">user</div>
            <div class="small" th:text="${#authentication.principal.attributes['email']} ?: '-'">-</div>
          </div>
        </div>
      </div>
      <div class="p-3">
        <div class="small text-muted">Subject ID</div>
        <div class="mb-2" th:text="${#authentication.principal.attributes['sub']} ?: '-'">-</div>

        <div class="small text-muted">Authorities</div>
        <div class="mb-3">
          <code class="d-inline-block px-2 py-1 me-1 mb-1 bg-light border rounded" th:each="a : ${#authentication.authorities}" th:text="${a}">ROLE_user</code>
        </div>

        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary" data-bs-target="#changePasswordModal" data-bs-toggle="modal">
            <i class="bi bi-key-fill"></i> Change Password
          </button>
          <form th:action="@{/logout}" method="post" class="d-grid">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
          </form>
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  </div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0" style="border-radius:16px; overflow:hidden;">
      <div class="modal-header text-white" style="background: linear-gradient(135deg,#2563eb,#7c3aed);">
        <h5 class="modal-title"><i class="bi bi-key-fill"></i> Change Password</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form th:action="@{/user/change-password}" method="post">
        <div class="modal-body">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <div class="mb-3">
            <label class="form-label">Old Password</label>
            <input type="password" class="form-control" name="oldPassword" required>
          </div>
          <div class="mb-3">
            <label class="form-label">New Password</label>
            <input type="password" class="form-control" name="newPassword" minlength="6" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <input type="password" class="form-control" name="confirmPassword" minlength="6" required>
          </div>
          <div class="form-text">Your password will be updated in Keycloak for your account.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Fallback: if redirected with ?success=... or ?error=..., show a temporary alert
  (function(){
    const params = new URLSearchParams(window.location.search);
    const success = params.get('success');
    const error = params.get('error');
    function show(msg, type){
      const wrap = document.createElement('div');
      wrap.className = 'container';
      const div = document.createElement('div');
      div.className = `alert alert-${type} alert-dismissible fade show shadow-sm`;
      div.role = 'alert';
      div.innerHTML = `${type==='success' ? '<i class="bi bi-check-circle-fill me-2"></i>' : '<i class="bi bi-exclamation-octagon-fill me-2"></i>'}` +
                      (msg || (type==='success'?'Success.':'Something went wrong.')) +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
      wrap.appendChild(div);
      document.querySelector('.content')?.prepend(wrap);
      setTimeout(()=>{ try { div.remove(); wrap.remove(); } catch(e){} }, 3000);
    }
    if (success) show(success, 'success');
    if (error) show(error, 'danger');
  })();
</script>
</body>
</html>
