<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8" />
    <title>User Permissions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #eef2ff, #e0f2fe); }
        .nav-gradient { background: linear-gradient(90deg, #2563eb, #7c3aed); box-shadow: 0 6px 16px rgba(0,0,0,.2); }
        .card { border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
        .table thead { background: linear-gradient(90deg, #3b82f6, #60a5fa); color: white; }
        .search-elevated { border: none; box-shadow: 0 8px 20px rgba(0,0,0,.10), 0 2px 6px rgba(0,0,0,.06); border-radius: 12px; overflow: hidden; }
        .badge-soft { background: rgba(37,99,235,.1); color: #1d4ed8; border: 1px solid rgba(37,99,235,.2) }
    </style>
</head>
<body>

<!-- Top bar -->
<nav class="navbar navbar-dark nav-gradient">
  <div class="container py-2">
    <div class="d-flex align-items-center w-100">
      <!-- Left: Back -->
      <a class="fw-semibold d-flex align-items-center gap-2 text-white text-decoration-none" href="/admin/permissions">
        <i class="bi bi-arrow-left-circle"></i>
        Back
      </a>

      <!-- Center: Title + username -->
      <div class="flex-grow-1 text-center">
        <h5 class="text-white mb-0 d-inline-flex align-items-center gap-2">User Permissions
          <span class="d-inline-flex align-items-center justify-content-center"
                style="width:24px;height:24px;border-radius:50%;background:#ffffff33;color:#fff;">
            <span th:text="${#strings.substring(username,0,1)}"></span>
          </span>
          <span class="badge rounded-pill" style="background:rgba(255,255,255,.9); color:#0f172a;" th:text="${username}">username</span>
        </h5>
      </div>

      <!-- Right: Refresh + Profile link/icon -->
      <div class="d-flex align-items-center gap-2">
        <a class="btn p-0" th:href="@{'/admin/permissions/user/' + ${username}}" title="Refresh">
          <span class="d-inline-flex align-items-center justify-content-center"
                style="width:36px;height:36px;border-radius:50%;background:#2563eb;color:#ffffff;box-shadow:0 2px 8px rgba(0,0,0,.15)">
            <i class="bi bi-arrow-clockwise"></i>
          </span>
        </a>
        <a href="#" class="text-white small text-decoration-underline" data-bs-toggle="modal" data-bs-target="#profileModal"></a>
        <button type="button" class="btn d-flex align-items-center justify-content-center"
                data-bs-toggle="modal" data-bs-target="#profileModal"
                style="width:38px;height:38px;border-radius:50%;background: linear-gradient(135deg,#7c3aed,#2563eb);color:#fff;box-shadow:0 6px 14px rgba(0,0,0,.25)">
          <i class="bi bi-person-fill"></i>
        </button>
    </div>
  </div>
</nav>

<div class="container py-4">

<!-- Current Permissions -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Current Permissions</h5>
            <div class="input-group search-elevated" style="max-width: 420px;">
                <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
                <input id="permSearch" type="text" class="form-control border-0" placeholder="Filter by code, name, description..." oninput="filterUserPerms()">
            </div>
        </div>

        <div class="table-responsive">
            <table id="userPermsTable" class="table table-hover align-middle mb-0">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Granted By</th>
                    <th>Granted At</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="up,iter : ${userPermissions}">
                    <td th:text="${iter.index + 1}">1</td>
                    <td><span class="badge badge-soft" th:text="${up.permission.code}">A</span></td>
                    <td th:text="${up.permission.name}">CREATE_USER</td>
                    <td th:text="${up.permission.description}">Create user in Keycloak and student details</td>
                    <td th:text="${up.grantedBy}">admin</td>
                    <td th:text="${#temporals.format(up.grantedAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 10:00</td>
                    <td>
                        <span th:if="${up.active}" class="badge text-bg-success">Active</span>
                        <span th:if="${!up.active}" class="badge text-bg-secondary">Inactive</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Assign Permissions -->
<div class="card">
    <div class="card-body">
        <h5 class="mb-3">Assign Permissions</h5>
        <form th:action="@{/admin/permissions/assign}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="username" th:value="${username}" />
            <input type="hidden" name="grantedBy" sec:authentication="name" />

            <!-- Dropdown with checkboxes -->
            <div class="mb-3">
                <label class="form-label">Select Permissions</label>
                <div class="position-relative">
                    <button type="button" id="dropdownBtn" class="form-control text-start" onclick="toggleDropdown('permDropdown')">
                        <span id="selSummary">Select permissions</span>
                    </button>
                    <div id="permDropdown" class="border rounded p-2 shadow bg-white position-absolute w-100 mt-1 d-none" style="z-index: 1000; max-height: 240px; overflow: auto;">
                        <div class="form-check mb-2" th:each="p : ${allPermissions}">
                            <input class="form-check-input" type="checkbox" name="codes" th:value="${p.code}" id="chk-[[${p.code}]]" onchange="updateSelectionSummary()">
                            <label class="form-check-label" th:for="${'chk-' + p.code}">
                                <strong th:text="${p.code}">A</strong>
                                <span th:text="${p.name}">CREATE_USER</span>
                                <small class="text-muted d-block" th:text="${p.description}">Create user in Keycloak and student details</small>
                            </label>
                        </div>
                        <div class="text-end pt-1">
                            <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleDropdown('permDropdown')">Done</button>
                        </div>
                    </div>
                </div>
                <div class="form-text">Tip: Click to expand, select A/B/C/D/E, click Done.</div>
            </div>

            <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Assign Selected</button>
            <a th:href="@{/admin/permissions}" class="btn btn-outline-secondary ms-2">Back</a>
        </form>
    </div>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-sm modal-dialog-scrollable">
    <div class="modal-content border-0" style="border-radius:16px; overflow:hidden;">
      <div class="p-4 text-white" style="background: linear-gradient(135deg,#2563eb,#7c3aed);">
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center justify-content-center"
               style="width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.2);">
            <i class="bi bi-person-fill fs-3"></i>
          </div>
          <div>
            <div class="fw-bold" sec:authentication="name">user</div>
            <div class="small" th:text="${#authentication.principal.attributes['email']} ?: '-'">-</div>
          </div>
        </div>
      </div>
      <div class="p-3">
        <div class="small text-muted">Subject ID</div>
        <div class="mb-2" th:text="${#authentication.principal.attributes['sub']} ?: '-'">-</div>
        <div class="small text-muted">Authorities</div>
        <div class="mb-3">
          <code class="d-inline-block px-2 py-1 me-1 mb-1 bg-light border rounded" th:each="a : ${#authentication.authorities}" th:text="${a}">ROLE_user</code>
        </div>
        <div class="d-grid gap-2">
          <form th:action="@{/logout}" method="post" class="d-grid">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
          </form>
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    function filterUserPerms(){
        const q = (document.getElementById('permSearch').value || '').toLowerCase();
        document.querySelectorAll('#userPermsTable tbody tr').forEach(r => {
            const text = r.innerText.toLowerCase();
            r.style.display = text.includes(q) ? '' : 'none';
        });
    }
    function toggleDropdown(id){
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.toggle('d-none');
    }
    function updateSelectionSummary(){
        const checks = document.querySelectorAll('#permDropdown input[name="codes"]:checked');
        const codes = Array.from(checks).map(c => c.value);
        document.getElementById('selSummary').innerText = codes.length ? codes.join(', ') : 'Select permissions';
    }
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e){
        const dd = document.getElementById('permDropdown');
        const btn = document.getElementById('dropdownBtn');
        if(!dd || !btn) return;
        if(!dd.contains(e.target) && !btn.contains(e.target)){
            dd.classList.add('d-none');
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
