<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Create Keycloak User</title>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
<div class="bg-white p-8 shadow-lg rounded-xl w-full max-w-md">
    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Create Keycloak User</h2>

    <!-- Form -->
    <form th:action="@{/admin/keycloak-users}" method="post" class="space-y-4" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
        <div>
            <label class="block text-gray-700">Username</label>
            <input type="text" name="username" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400" required>
        </div>
        <div>
            <label class="block text-gray-700">Email</label>
            <input type="email" name="email" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400" required>
        </div>
        <div>
            <label class="block text-gray-700">Password</label>
            <input type="password" name="password" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400" required>
        </div>
        <div>
            <label class="block text-gray-700">Role</label>
            <input type="text" name="role" placeholder="e.g. ADMIN or USER" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400" required>
        </div>

        <!-- Permissions (dropdown with checkboxes + definitions) -->
        <div>
            <div class="flex items-center justify-between mb-2">
                <label class="block text-gray-700">Assign Permissions</label>
                <!-- Tooltip trigger -->
                <span class="relative group cursor-help text-gray-600" aria-label="Permission Help">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
                    </svg>
                    <!-- Tooltip content (hidden until hover) -->
                    <div class="absolute right-0 z-10 hidden group-hover:block w-64 p-3 mt-2 text-sm text-gray-800 bg-white border border-gray-200 rounded-lg shadow-lg">
                        <div class="font-semibold mb-1">Permissions</div>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>A</strong>: Create user in Keycloak + student details</li>
                            <li><strong>B</strong>: Delete user in Keycloak + students in DB</li>
                            <li><strong>C</strong>: Update Keycloak + student details</li>
                            <li><strong>D</strong>: Change password in Keycloak</li>
                            <li><strong>E</strong>: View permissions pages</li>
                        </ul>
                    </div>
                </span>
            </div>

            <!-- Custom dropdown -->
            <div class="relative" x-data="{ open: false }">
                <button type="button" id="permDropdownBtn"
                        class="w-full border rounded-lg px-3 py-2 flex items-center justify-between hover:border-blue-400"
                        onclick="document.getElementById('permDropdown').classList.toggle('hidden')">
                    <span id="permSummary" class="text-gray-700">Select permissions</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.187l3.71-3.956a.75.75 0 111.08 1.04l-4.24 4.52a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>

                <div id="permDropdown" class="absolute z-20 mt-2 w-full bg-white border border-gray-200 rounded-lg shadow-lg p-3 hidden">
                    <div class="space-y-2 max-h-48 overflow-auto" th:if="${allPermissions}">
                        <label class="flex items-start gap-3 p-2 rounded hover:bg-gray-50" th:each="p : ${allPermissions}">
                            <input type="checkbox" name="codes" th:value="${p.code}" class="mt-1 w-4 h-4">
                            <div>
                                <div class="font-semibold" th:text="${p.code} + ' - ' + ${p.name}">A - CREATE_USER</div>
                                <div class="text-xs text-gray-500" th:text="${p.description}">Create user in Keycloak and student details</div>
                            </div>
                        </label>
                    </div>
                    <p class="text-sm text-gray-500" th:if="${allPermissions == null}">No permissions loaded.</p>
                    <div class="flex justify-end pt-2">
                        <button type="button" class="text-sm text-blue-600 hover:underline" onclick="document.getElementById('permDropdown').classList.add('hidden')">Done</button>
                    </div>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Selected: <span id="permSelectedText">None</span></p>
        </div>
        <input type="hidden" name="grantedBy" sec:authentication="name" />

        <!-- Create User Button -->
        <button type="submit"
                class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-2 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 4v1m0 14v1m8-9h1M3 12H2m15.364-6.364l.707.707M5.636 18.364l-.707.707M18.364 18.364l.707-.707M5.636 5.636l-.707-.707M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Create User
        </button>
    </form>

    <!-- Messages -->
    <div th:if="${message}" class="text-green-600 mt-4 text-center" th:text="${message}"></div>
    <div th:if="${error}" class="text-red-600 mt-4 text-center" th:text="${error}"></div>

    <!-- Navigation Buttons -->
    <div class="flex justify-between items-center mt-6 gap-3">
        <a href="/admin/dashboard"
           class="flex items-center gap-2 bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow hover:from-gray-300 hover:to-gray-400 transition">
            Dashboard
        </a>
        <a href="/students/new"
           class="flex items-center gap-2 bg-gradient-to-r from-pink-500 to-rose-500 text-white px-4 py-2 rounded-lg shadow hover:from-pink-600 hover:to-rose-600 transition">
            Add Student
        </a>
    </div>
</div>
</body>
<script>
    // Update summary text and selected count for permissions
    (function(){
        const dropdown = document.getElementById('permDropdown');
        const summary = document.getElementById('permSummary');
        const selectedText = document.getElementById('permSelectedText');

        function updateSummary() {
            const checks = dropdown ? dropdown.querySelectorAll('input[name="codes"]:checked') : [];
            const codes = Array.from(checks).map(c => c.value);
            if (codes.length === 0) {
                summary.textContent = 'Select permissions';
                selectedText.textContent = 'None';
            } else {
                summary.textContent = codes.join(', ');
                selectedText.textContent = codes.join(', ');
            }
        }

        document.addEventListener('change', function(e){
            if (e.target && e.target.name === 'codes') {
                updateSummary();
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e){
            const btn = document.getElementById('permDropdownBtn');
            if (!dropdown || !btn) return;
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Initialize
        updateSummary();
    })();
</script>
</html>
